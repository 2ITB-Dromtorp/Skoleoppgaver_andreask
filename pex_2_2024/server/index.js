const e=require("http"),fs=require("fs"),t=require("https"),a=require("path"),s=require("express"),r=require("dotenv"),i=require("mongodb"),c=require("bcrypt"),o=require("jsonwebtoken"),u=require("./modules/value_validator")["checkRequestValueFull"],n=(r.config(),process.env.PORT||80),d=process.env.JWT_SECRET||"jwtsecret",l=new i.MongoClient(process.env.MONGODB_URL);let m=!1,p,g,y,b,h;l.connect().then(()=>{m=!0,p=l.db("kantine"),g=p.collection("users"),y=p.collection("user_sessions"),b=p.collection("inventory"),h=p.collection("orders"),console.log("Successfully connected to MongoDB database")}).catch(e=>{console.error("Error connecting to MongoDB database:",e)});const w=s(),f={key:fs.readFileSync('C:/Certbot/live/mulighet.no-0003/privkey.pem','utf8'),cert:fs.readFileSync('C:/Certbot/live/mulighet.no-0003/fullchain.pem','utf8')},v=t.createServer(f,w);function j(e,...t){return"/"+["api","v"+e.toString(),...t].join("/")}function C(s){return new Promise(async(e,t)=>{var a=o.sign({userId:s},d,{expiresIn:"7d"});try{e([a,y.insertOne({userId:s,token:a})])}catch(e){t(e)}})}v.listen(n,()=>{console.log("HTTPS server started on port "+n.toString())}),w.use(s.json()),w.use(s.static(a.resolve(__dirname,"build"))),w.use(async(t,a,s)=>{var r=t.headers.authorization;if(r){r=r.split(" ")[1];let e=!1;try{e=o.verify(r,d)}finally{if(!1===e)return void s()}try{var i,n=await y.findOne({token:r});n?((i=await g.findOne({_id:n.userId}))?t.user=i:console.error("User session used with user that does not exist"),s()):s()}catch(e){console.error(e),a.status(500).send()}}else s()}),w.use("/api",(e,t,a)=>{a()}),w.get(j(1,"user","data"),async(e,t)=>{e=e.user;if(!e)return t.status(401).send();t.status(200).json({_id:e._id,username:e.username,email:e.email})}),w.get(j(1,"user","orders"),async(e,t)=>{e=e.user;if(!e)return t.status(401).send();try{var a=await h.find({userId:e._id});t.status(200).json({orders:a.map(e=>({userId:e.userId,items:e.items}))})}catch(e){console.error(e),t.status(500).send()}}),w.get(j(1,"items","available"),async(e,t)=>{try{var a=await b.find({}).limit(10).toArray();t.send(a.map(e=>({id:e.id,name:e.name,image:e.image,quantity:e.quantity})))}catch(e){console.error(e),t.status(500).send()}}),w.get(j(1,"menu","categories"),async(e,t)=>{t.status(200).json({categories:[{value:"mat",label:"Mat",subCategories:[{value:"måltid",label:"Måltid"},{value:"snacks",label:"Snacks"},{value:"frukt",label:"Frukt"}]},{value:"drikke",label:"Drikke",subCategories:[{value:"brus",label:"Brus"},{value:"juice",label:"Juice"},{value:"vann",label:"Vann"}]}]})}),w.post(j(1,"menu","items"),async(e,t)=>{try{var a=await b.find({}).toArray();t.status(200).json({results:a.map(e=>({id:e.id,name:e.name,image:e.image,price:e.price,quantity:e.quantity,category:e.category,subCategory:e.subCategory}))})}catch(e){console.error(e),t.status(500).send()}}),w.post(j(1,"user","signup"),async(t,a)=>{t=t.body;let s=t.username;if(!1!==u(a,s,"username","string")){s=s.toLowerCase();let e=t.email;if(!1!==u(a,e,"email","string")){e=e.toLowerCase();t=t.username;if(!1!==u(a,t,"password","string"))try{var r,i,n,o=await g.findOne({$or:[{username:s},{email:e}]});o?a.status(409).json({conflictProperty:s===o.username?"username":e===o.email?"email":""}):(r=await c.hash(t,12),i=await g.insertOne({username:s,email:e,password:r}),n=(await C((await g.findOne({_id:i.insertedId}))._id))["0"],a.status(200).json({token:n}))}catch(e){console.error(e),a.status(500).send()}}}}),w.post(j(1,"user","login"),async(e,t)=>{e=e.body;let a=e.username;if(!1!==u(t,a,"username","string")){a=a.toLowerCase();e=e.password;if(!1!==u(t,e,"password","string"))try{var s,r=await g.findOne({username:a});r?!1===c.compareSync(e,r.password)?t.status(401).send("Incorrect password"):(s=(await C(r._id))["0"],t.status(200).json({token:s})):t.status(404).send()}catch(e){console.error(e),t.status(500).send()}}}),w.post(j(1,"order","pay"),async(e,t)=>{var a=e.body,s=a.card;if(!1!==u(t,s,"card","object")){a=a.items;if(!1!==u(t,a,"items","object")){var r=s.number;if(!1!==u(t,r,"cardNumber","string")){r=s.expiryDate;if(!1!==u(t,r,"cardExpiryDate","string")){r=s.cvc;if(!1!==u(t,r,"cardCvc","string"))try{var i,n,o={items:a};e.user&&(o.userId=e.user._id),await h.insertOne(o);for([i,n]of Object.entries(a))await b.updateOne({id:parseInt(i)},{$inc:{quantity:-n}});t.status(200).json({success:!0})}catch(e){console.error(e),t.status(500).send()}}}}}});const q=[{id:0,name:"Kjeks",category:"mat",subCategory:"snacks",price:16,quantity:20,image:"https://upload.wikimedia.org/wikipedia/commons/f/f1/2ChocolateChipCookies.jpg"},{id:1,name:"Potetgull",category:"mat",subCategory:"snacks",price:20,quantity:20,image:"https://www.allrecipes.com/thmb/WyCC-RL8cuAEKfYHsdnzqi64iTc=/1500x0/filters:no_upscale():max_bytes(150000):strip_icc()/73135-homestyle-potato-chips-ddmfs-0348-3x4-hero-c21021303c8849bbb40c1007bfa9af6e.jpg"},{id:2,name:"Pizza",category:"mat",subCategory:"måltid",price:30,quantity:20,image:"https://cdn-yams.godt.no/api/v1/godt-recipe/images/-nduja-pizza---deilig-og-spicy?rule=w4000_auto"},{id:3,name:"Sandwich",category:"mat",subCategory:"måltid",price:20,quantity:20,image:"https://www.southernliving.com/thmb/UW4kKKL-_M3WgP7pkL6Pb6lwcgM=/1500x0/filters:no_upscale():max_bytes(150000):strip_icc()/Ham_Sandwich_011-1-49227336bc074513aaf8fdbde440eafe.jpg"},{id:4,name:"Salat",category:"mat",subCategory:"måltid",price:40,quantity:20,image:"https://assets.bonappetit.com/photos/57acbde8f1c801a1038bc713/1:1/w_2560%2Cc_limit/chopped-spring-salad.jpg"},{id:5,name:"Nudler",category:"mat",subCategory:"måltid",price:5,quantity:20,image:"https://tiffycooks.com/wp-content/uploads/2021/09/Screen-Shot-2021-09-21-at-5.21.37-PM.png"},{id:6,name:"Eggesalat",category:"mat",subCategory:"måltid",price:35,quantity:20,image:"https://cdn.loveandlemons.com/wp-content/uploads/2024/03/egg-salad-recipe.jpg"},{id:7,name:"Eple",category:"mat",subCategory:"frukt",price:8,quantity:20,image:"https://www.gisymbol.com/wp-content/uploads/2017/08/AustralianApple.png"},{id:8,name:"Banan",category:"mat",subCategory:"frukt",price:8,quantity:20,image:"https://images.immediate.co.uk/production/volatile/sites/30/2017/01/Bunch-of-bananas-67e91d5.jpg?quality=90&resize=440,400"},{id:9,name:"Pepsi",category:"drikke",subCategory:"brus",price:19,quantity:20,image:"https://gastrocatering.no/media/xhnjsvip/pepsi2.jpg?anchor=center&mode=crop&width=800&height=800&rnd=133015860978900000"},{id:10,name:"Coca Cola",category:"drikke",subCategory:"brus",price:19,quantity:20,image:"https://www.coca-cola.com/content/dam/onexp/no/no/home-images/brands/coca-cola/no_cocacola_original_750x750.jpg"},{id:11,name:"Eplejuice",category:"drikke",subCategory:"juice",price:12,quantity:20,image:"https://nellaspizza.com/wp-content/uploads/2020/08/apple-juice.jpg"},{id:11,name:"Appelsinjuice",category:"drikke",subCategory:"juice",price:12,quantity:20,image:"https://cdn3.didevelop.com/public/cdn/533_832b385ca297739e21d87440e1b1a82d.jpg"},{id:12,name:"Vann",category:"drikke",subCategory:"vann",price:8,quantity:20,image:"https://lh4.googleusercontent.com/proxy/5ahffMFJ-VFPJnm341VLs9h8dZTkDhURZ0VKM6Z-SvDkZCd1bg6DhjSQlkE6SubKO-AGiTaY3eC4Ytpt3q3tsw5jF9OfFvmwZJzWKq0"}];